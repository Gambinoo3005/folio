# Per-Client Site Provisioning Hook Specification

## Overview
This document defines the minimal environment variables that each client Vercel project receives during the provisioning pipeline, driven by the Inngest workflow.

## Client Project Environment Variables

### Required Variables
Each new client repository/project must have these environment variables set via the Vercel API:

```bash
SITE_ID=<guid-from-platform-db>
NEXT_PUBLIC_API_BASE=https://api.folio.com
NEXT_PUBLIC_CDN_BASE=https://cdn.folio.com
```

### Variable Descriptions

#### `SITE_ID`
- **Type**: GUID/UUID string
- **Source**: Generated by platform database when client is created
- **Purpose**: Unique identifier linking client site to platform data
- **Example**: `550e8400-e29b-41d4-a716-446655440000`

#### `NEXT_PUBLIC_API_BASE`
- **Type**: URL string
- **Value**: `https://api.folio.com` (production)
- **Purpose**: Base URL for API calls from client site
- **Environment Variants**:
  - Production: `https://api.folio.com`
  - Staging: `https://api-staging.folio.com`
  - Development: `https://api-dev.folio.com`

#### `NEXT_PUBLIC_CDN_BASE`
- **Type**: URL string
- **Value**: `https://cdn.folio.com` (production)
- **Purpose**: Base URL for CDN assets (images, files)
- **Environment Variants**:
  - Production: `https://cdn.folio.com`
  - Staging: `https://cdn-staging.folio.com`
  - Development: `https://cdn-dev.folio.com`

## Provisioning Pipeline Integration

### Inngest Workflow
The provisioning process should be integrated into the tenant creation workflow:

```typescript
// Example Inngest function for client provisioning
export const provisionClientSite = inngest.createFunction(
  { id: "provision-client-site" },
  { event: "client.created" },
  async ({ event, step }) => {
    const { clientId, siteId } = event.data;
    
    // Step 1: Create Vercel project
    const project = await step.run("create-vercel-project", async () => {
      return await createVercelProject({
        name: `folio-client-${clientId}`,
        framework: "nextjs",
        // ... other project settings
      });
    });
    
    // Step 2: Set environment variables
    await step.run("set-env-vars", async () => {
      return await setVercelEnvironmentVariables(project.id, {
        SITE_ID: siteId,
        NEXT_PUBLIC_API_BASE: process.env.API_BASE_URL,
        NEXT_PUBLIC_CDN_BASE: process.env.NEXT_PUBLIC_CDN_BASE,
      });
    });
    
    // Step 3: Deploy initial site
    await step.run("deploy-site", async () => {
      return await deployVercelProject(project.id);
    });
    
    return { success: true, projectId: project.id };
  }
);
```

### Vercel API Integration
Use the Vercel API to set environment variables:

```typescript
async function setVercelEnvironmentVariables(
  projectId: string, 
  envVars: Record<string, string>
) {
  const response = await fetch(
    `https://api.vercel.com/v10/projects/${projectId}/env`,
    {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${process.env.VERCEL_TOKEN}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        key: 'SITE_ID',
        value: envVars.SITE_ID,
        type: 'encrypted',
        target: ['production', 'preview', 'development']
      })
    }
  );
  
  // Repeat for each environment variable
  // ...
}
```

## Environment-Specific Values

### Production Environment
```bash
SITE_ID=<production-guid>
NEXT_PUBLIC_API_BASE=https://api.folio.com
NEXT_PUBLIC_CDN_BASE=https://cdn.folio.com
```

### Staging Environment
```bash
SITE_ID=<staging-guid>
NEXT_PUBLIC_API_BASE=https://api-staging.folio.com
NEXT_PUBLIC_CDN_BASE=https://cdn-staging.folio.com
```

### Development Environment
```bash
SITE_ID=<dev-guid>
NEXT_PUBLIC_API_BASE=https://api-dev.folio.com
NEXT_PUBLIC_CDN_BASE=https://cdn-dev.folio.com
```

## Security Considerations

### Secret Isolation
- **Client projects contain NO sensitive secrets**
- All authentication, database, and service secrets remain in platform
- Client sites only receive public-facing configuration

### Access Control
- Use least-privilege Vercel tokens for provisioning
- Limit token scope to project creation and environment variable setting
- Rotate provisioning tokens regularly

### Audit Trail
- Log all client provisioning activities
- Track which environment variables are set for each client
- Monitor for unauthorized access to client projects

## Implementation Checklist

### Phase 1: Basic Provisioning
- [ ] Create Inngest workflow for client creation
- [ ] Implement Vercel API integration
- [ ] Set up environment variable setting
- [ ] Test with development environment

### Phase 2: Environment Support
- [ ] Add staging environment support
- [ ] Implement environment-specific URLs
- [ ] Add error handling and retry logic
- [ ] Create monitoring and alerting

### Phase 3: Production Ready
- [ ] Add production environment support
- [ ] Implement security controls
- [ ] Add audit logging
- [ ] Create documentation and runbooks

## Error Handling

### Common Scenarios
1. **Vercel API Rate Limits**: Implement exponential backoff
2. **Project Creation Failures**: Retry with different naming
3. **Environment Variable Conflicts**: Check existing vars before setting
4. **Network Timeouts**: Implement retry logic with circuit breaker

### Monitoring
- Track provisioning success/failure rates
- Monitor API response times
- Alert on repeated failures
- Log all provisioning activities

## Testing

### Unit Tests
- Test environment variable setting logic
- Mock Vercel API responses
- Test error handling scenarios

### Integration Tests
- Test full provisioning workflow
- Verify environment variables are set correctly
- Test with different client configurations

### End-to-End Tests
- Create test client and verify site functionality
- Test across all environments
- Verify client can access platform APIs

---

**Last Updated**: September 22, 2025  
**Next Review**: October 22, 2025  
**Version**: 1.0
